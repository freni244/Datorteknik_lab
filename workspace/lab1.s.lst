68K GAS  ./lab1.s 			page 1


   1               	;;vanliga misstag kan vara att absolut/omedelbar adresseringsmod #/#$/$
   2               	;;kontrollera suffix .b (8) .w(16) .l(32)
   3               	;;glÃƒÂ¶m inte att sÃƒÂ¤tta stackpekaren
   4               	;;kolla logiska problem i programmet mha trace
   5               	;;dela upp programmet i subutiner och testa en i taget
   6               		
   7               	;$1000 start
   8               	;$4000-$4003 4 senaste hexa-tecknen
   9               	;$4010-$4013 korrekt kod
  10               	;$4020- textstrï¾ƒï½¤ngen'Felakig kod!'
  11               	;$7000 startvï¾ƒï½¤rde fï¾ƒ stackpekaren 
  12               	;set stackpointer->subrutin->...->move to monitor...rts
  13               	start:
  14 0000 2E7C 0000 		move.l #$7000,a7   	;sï¾ƒtackpekaren till a7 (a7 brukar vara tom)
  14      7000 
  15               	
  16 0006 4EBA 0050 		jsr setuppia		;drar igï¾ƒï½¥ng PIA A,B,C
  17 000a 4EBA 0100 		jsr code		;bestÃƒÂ¤mmer rÃƒÂ¤tt kod till lÃƒÂ¥set
  18 000e 4EBA 0116 		jsr error		;spara errormeddelande pÃƒÂ¥ $4020
  19 0012 4EBA 00D6 		jsr clearinput		;rensa inbuffer
  20 0016 6000 0082 		bra deactivatealarm	;avaktivera larm
  21 001a 4EBA 0006 		jsr activatealarm	;aktivera larm
  22 001e 4EBA 009C 		jsr getkey
  23               		
  24               	activatealarm:
  25               	;;; ;   F??orberedelseuppgift: Skriv denna subrutn!
  26               	;;; ;   samma h??r som de-.s l??s f??rel??snsanteckningar fr??n f?? 04
  27 0022 23F9 0001 		        move.l $10080,$10082
  27      0080 0001 
  27      0082 
  28 002c 0079 0001 		        or #$01,$10082  ;tÃ¢Â–Â’nd lampan
  28      0001 0082 
  29 0034 23F9 0001 		        move.l $10082,$10080
  29      0082 0001 
  29      0080 
  30 003e 4E75      		        rts
  31               	;;; ; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  32               	
  33               		
  34               	printchar:		    ;utskrift i terminal
  35 0040 1F05      		move.b d5,-(a7)     ; Spara undan d5 (bit 7-0) pp stacken
  36               	waittx:	
  37 0042 1A39 0001 		move.b $10040,d5    ; Serieportens statusregister
  37      0040 
  38 0048 0205 0002 		and.b  #2,d5        ; Isolera bit 1 (Ready to transmit)
  39 004c 67F4      		beq waittx          ; Vï¾ƒï½¤nta tills serieporten ï¾ƒï½¤r klar att sï¾ƒï½¤nda
  40 004e 13C4 0001 		move.b d4,$10042    ; Skicka ut
  40      0042 
  41 0054 1A1F      		move.b (a7)+,d5     ; ï¾ƒï½¥terstï¾ƒï½¤ll d5
  42 0056 4E75      		rts 		    ; Tips: Sï¾ƒï½¤tt en breakpoint hï¾ƒï½¤r om du har problem med trace
  43               	
  44               	setuppia:	;initering
  45 0058 13FC 0000 		move.b #0,$10084    ; Vï¾ƒï½¤lj datariktningsregistret (DDRA)
  45      0001 0084 
  46 0060 13FC 0001 		move.b #1,$10080    ; Sï¾ƒï½¤tt pinne 0 pï¾ƒï½¥ PIAA som utgÃƒÂ¥ng
  46      0001 0080 
  47 0068 13FC 0004 		move.b #4,$10084    ; Vï¾ƒï½¤lj in/utgï¾ƒï½¥ngsregistret
68K GAS  ./lab1.s 			page 2


  47      0001 0084 
  48 0070 13FC 0000 		move.b #0,$10086    ; Vï¾ƒï½¤lj datariktningsregistret (DDRB)
  48      0001 0086 
  49 0078 13FC 0000 		move.b #0,$10082    ; Sï¾ƒï½¤tt alla pinnar som ingï¾ƒï½¥ngar
  49      0001 0082 
  50 0080 13FC 0004 		move.b #4,$10086    ; Vï¾ƒï½¤lj in/utgï¾ƒï½¥ngsregistret
  50      0001 0086 
  51 0088 4E75      		rts
  52               	
  53               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  54               	;;;   Inargument: Pekare till strï¾‚ï½¨angen i a4
  55               	;;;   Lï¾‚ï½¨angd pï¾‹å•¾ strï¾‚ï½¨angen i d5
  56               	printstring:
  57               	;;;   Fï¾‚ï½¨orberedelseuppgift: Skriv denna subrutin!
  58               	;;;   vi kan loopa mha printchar och nï¾ƒï½¤rlï¾ƒï½¤ngden av d5 ï¾ƒï½¤r 0
  59               	;;;   vet vi att alla tecken blir utskrivna
  60 008a 2827      		move.l -(a7),d4		;flyttar pekaren till a4
  61 008c 4EBA FFB2 		jsr printchar		;ï¾ƒï½¥teranvï¾ƒï½¤nd stack-funktionaliteten hï¾ƒï½¤r
  62 0090 5385      		sub.l #1,d5		;minskar lï¾ƒï½¤ngd d5 nmed 1 nu neftr printen
  63 0092 6704      		beq fin			;ljï¾ƒï½¤mfï¾ƒï½¶r om branc ï¾ƒï½¤r 'equal'
  64 0094 60F4      		bra printstring		;hoppa direkt till bï¾ƒï½¶rjan
  65 0096 4E75      		rts			;gï¾ƒï½¥ till subrutinen som kallade pï¾ƒï½¥ printstring
  66               	
  67 0098 4E75      	fin:	rts			;hoppa tillbaka om alla element Ãƒr utskrvna
  68               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  69               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  70               	;;;   Inargument: Inga
  71               	;;;   Utargument: Inga
  72               	;;;
  73               	;;;   Funktion: Slï¾‚ï½¨acker lysdioden kopplad till PIAA
  74               	
  75               	deactivatealarm:
  76               	;;;   Fï¾‚ï½¨orberedelseuppgift: Skriv denna subrutin!
  77               	;;;   hï¾ƒï½¤r kan man helt enkelt kolla pï¾ƒï½¥ fï¾ƒï½¶relï¾ƒï½¤sningsanteckningarna frï¾ƒï½¥n fï¾
  78               	;;;   move LED,D
  79               	;;;    or #$FD,D
  80               	;;;   move D,LED
  81 009a 23F9 0001 		move.l $10080,$10082
  81      0080 0001 
  81      0082 
  82 00a4 0079 00FD 		or #$FD,$10082 		;slï¾ƒï½¤cker lampan
  82      0001 0082 
  83 00ac 23F9 0001 		move.l $10082,$10080
  83      0082 0001 
  83      0080 
  84 00b6 4EBA 0032 		jsr clearinput
  85 00ba 4E75      		rts			;undrar om denna rts behÃƒÂ¶vs
  86               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  87               		
  88               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  89               	;;;   Inargument: Inga
  90               	;;;   Utargument: Tryckt knappt returneras i d4
  91               	getkey:	
  92               	;;;   Fï¾‚ï½¨orberedelseuppgift: Skriv denna subrutin!
  93               	;;;   hï¾ƒï½¤r lï¾ƒï½¤ser vi av piab 0, piab 1, piab 2, piab 3 med abcd och a=MSB
  94               	;;;   kolla setuppia-rutinen fï¾ƒï½¶ ingï¾ƒï½¥ngar till hexa-tangentborde
  95               	;;;   om hexa-tecknet ï¾ƒï½¤r mellan 0 och 9 skrivs en siffra utannars inte
68K GAS  ./lab1.s 			page 3


  96 00bc 183C 0000 		move.b #$00,d4		;tÃƒÂ¶m minnet
  97 00c0 2A39 0001 		move.l $10082,d5 	;inmatning frï¾ƒï½¥n PIAB
  97      0082 
  98 00c6 0C04 0009 	        cmp.b #9,d4		;kollar om hexkey ??r st??rre ??n 9
  99 00ca 6FF0      		jle getkey	 	;om d4<=9 lÃƒÂ¤ggstecknet pÃƒÂ¥ stacken
 100 00cc 21C4 4000 		move.l d4,$4000		;inmatning av kod till minne
 101 00d0 4E75      		rts
 102               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 103               	
 104               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 105               	;;;   Inargument: Vald tangent i d4
 106               	;;;   Utargument: Inga
 107               	;;;
 108               	;;;   Funktion: Flyttar inneh???llet p??? $4001-$4003 bak???t en byte till
 109               	;;;   $4000-$4002. Lagrar sedan inneh???llet i d4 p??? adress $4003.
 110               	addkey:
 111               	;;;   F??orberedelseuppgift: Skriv denna subrutin
 112 00d2 0C04 0009 		        cmp.b #9,d4 	;kollar om hexkey ??r st??rre ??n 9
 113 00d6 6E10      		        bgt g_t_9	;om d4 sst?rre ?n??9->hoppa ut
 114 00d8 2838 4010 		        move.l $4010,d4 ;annars detta
 115 00dc E18C      		        lsl.l #8,d4     ;forts??tter vidare i str??ngen
 116 00de 21C4 4010 		        move.l d4,$4010 ;flyttar tillbaka d3 till 4 senaste hexa-tecknen
 117 00e2 21C4 4013 		        move.l d4,$4013 ;senaste siffran i PIAB
 118 00e6 4E75      		        rts
 119               	g_t_9:
 120 00e8 4E75      		        rts
 121               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 122               		
 123               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 124               	;;;   Inargument: Inga
 125               	;;;   Utargument: Inga
 126               	;;;
 127               	;;;   Funktion: SÃ‚Â¨atter innehÃ‹Âšallet pÃ‹Âša $4000-$4003 till $FF
 128               	clearinput:	
 129               	;;;   FÃ‚Â¨orberedelseuppgift: Skriv denna subrutin
 130               	;;;   HÃƒÂ¤r kan i fylla minnet med 20 bitar (minneskapaciteten i MC68008)
 131               	;;;   typ som setup i dugga1 fast istÃƒÂ¤Ã¯Â¿Â½llet med tomma vÃƒÂ¤rden
 132 00ea 21FC FFFF 		move.l #$ffffffff,$4000
 132      FFFF 4000 
 133 00f2 4E75      		rts
 134               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 135               	
 136               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 137               	;;;   Inargument: Inga
 138               	;;;   Utargument: Returnerar 1 i d4 om koden var korrekt, annars 0 i d4
 139               	;;;   hÃƒÂ¤r kan vi antingen ÃƒÂ¤ndra vÃƒÂ¤rden internt i checkcode eller
 140               	;;;   hoppa till ytterligare subrutiner och ÃƒÂ¤ndra
 141               	checkcode:	
 142               	;;;   FÃ‚Â¨orberedelseuppgift: Skriv denna subrutin
 143 00f4 2438 4010 		move.l $4010,d2 	;vi kollar input
 144 00f8 2638 4000 		move.l $4000,d3		;vi lÃƒÂ¤gger fram korrekt kod
 145 00fc B682      		cmp.l d2,d3		;vi jÃƒÂ¤mfÃƒÂ¶input med korrekt kod
 146 00fe 6706      		beq correct		;om rkorrekt sÃƒÂ¤tts d4 till 1
 147 0100 183C 0000 		move.b #0,d4		;annars 0 i d4
 148 0104 4E75      		rts
 149               	correct:
 150 0106 183C 0001 		move.b #1,d4		;checkcode hoppar hit om d2 och d3 ÃƒÂ¤r samma
68K GAS  ./lab1.s 			page 4


 151 010a 4E75      		rts
 152               	;;; ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 153               	
 154               	code:
 155 010c 11FC 0000 		move.b #$00,$4010
 155      4010 
 156 0112 11FC 0000 		move.b #$00,$4011
 156      4011 
 157 0118 11FC 0000 		move.b #$00,$4012
 157      4012 
 158 011e 11FC 0000 		move.b #$00,$4013
 158      4013 
 159 0124 4E75      		rts
 160               	
 161               	error:
 162 0126 1A3C 000E 	        move.b #14,d5		;lÃƒÂ¤ngd av meddelande
 163               	
 164 012a 11FC 0046 	        move.b #'F',$4020 	;meddelande
 164      4020 
 165 0130 11FC 0045 	        move.b #'E',$4021
 165      4021 
 166 0136 11FC 004C 	        move.b #'L',$4022
 166      4022 
 167 013c 11FC 0041 	        move.b #'A',$4023
 167      4023 
 168 0142 11FC 004B 	        move.b #'K',$4024
 168      4024 
 169 0148 11FC 0054 	        move.b #'T',$4025
 169      4025 
 170 014e 11FC 0049 	        move.b #'I',$4026
 170      4026 
 171 0154 11FC 0047 	        move.b #'G',$4027
 171      4027 
 172 015a 11FC 0020 	        move.b #' ',$4028
 172      4028 
 173 0160 11FC 004B 	        move.b #'K',$4029
 173      4029 
 174 0166 11FC 004F 	        move.b #'O',$402A
 174      402A 
 175 016c 11FC 0044 	        move.b #'D',$402B
 175      402B 
 176 0172 11FC 0021 	        move.b #'!',$402C
 176      402C 
 177 0178 4E75      	        rts
